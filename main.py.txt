import discord
from discord import app_commands, Webhook
import random
import datetime
import aiohttp
import os

intents = discord.Intents.all()
client = discord.Client(intents=intents)
tree = app_commands.CommandTree(client)

TOKEN = os.getenv("DISCORD_BOT_TOKEN")
WEBHOOK_URL = os.getenv("TWEET_WEBHOOK_URL")
AVATAR_URL = os.getenv("TWEET_AVATAR_URL")

@client.event
async def on_ready():
    print(f"âœ… Logged in as {client.user}")
    await client.change_presence(activity=discord.Game(name="LYX is here!"))
    await tree.sync()
    print("âœ… Slash commands synced")

@client.event
async def on_member_join(member):
    channel = discord.utils.get(member.guild.text_channels, name="ã€¢ğ–ğğ¥ğœğ¨ğ¦ğ")
    if channel:
        await channel.send(f"ã€¢ğ–ğğ¥ğœğ¨ğ¦ğ {member.mention} to {member.guild.name}!")

    role = discord.utils.get(member.guild.roles, name="ğ‹ğ˜ğ—")
    if role:
        await member.add_roles(role)

@tree.command(name="ping", description="Ø¹Ø±Ø¶ Ø³Ø±Ø¹Ø© Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø¨ÙˆØª")
async def ping(interaction: discord.Interaction):
    latency = round(client.latency * 1000)
    await interaction.response.send_message(f"ğŸ“ Pong! {latency}ms")

@tree.command(name="clear", description="Ø­Ø°Ù Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„")
@app_commands.describe(amount="Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡Ø§")
async def clear(interaction: discord.Interaction, amount: int):
    if interaction.user.guild_permissions.manage_messages:
        await interaction.channel.purge(limit=amount)
        await interaction.response.send_message(f"ğŸ§¹ ØªÙ… Ø­Ø°Ù {amount} Ø±Ø³Ø§Ù„Ø©", ephemeral=True)
    else:
        await interaction.response.send_message("âŒ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„", ephemeral=True)

@tree.command(name="ban", description="Ø­Ø¸Ø± Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±")
@app_commands.describe(member="Ø§Ù„Ø¹Ø¶Ùˆ", reason="Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø±")
async def ban(interaction: discord.Interaction, member: discord.Member, reason: str = "No reason provided"):
    if interaction.user.guild_permissions.ban_members:
        await member.ban(reason=reason)
        await interaction.response.send_message(f"ğŸ”¨ ØªÙ… Ø­Ø¸Ø± {member.name} | Ø§Ù„Ø³Ø¨Ø¨: {reason}")
    else:
        await interaction.response.send_message("âŒ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø­Ø¸Ø±", ephemeral=True)

@client.event
async def on_message(message):
    if message.author.bot:
        return

    if message.channel.name == "ã€¢ğ“ğ°ğğğ­ğ¬":
        try:
            async with aiohttp.ClientSession() as session:
                webhook = Webhook.from_url(WEBHOOK_URL, session=session)

                embed = discord.Embed(
                    description=message.content,
                    color=discord.Color.dark_gray()
                )
                embed.set_author(name=message.author.name, icon_url=message.author.display_avatar.url)

                if message.attachments:
                    embed.set_image(url=message.attachments[0].url)

                days_ar = {
                    "Saturday": "Ø§Ù„Ø³Ø¨Øª",
                    "Sunday": "Ø§Ù„Ø£Ø­Ø¯",
                    "Monday": "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†",
                    "Tuesday": "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡",
                    "Wednesday": "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡",
                    "Thursday": "Ø§Ù„Ø®Ù…ÙŠØ³",
                    "Friday": "Ø§Ù„Ø¬Ù…Ø¹Ø©"
                }
                today_en = datetime.datetime.utcnow().strftime('%A')
                today_ar = days_ar.get(today_en, today_en)
                embed.set_footer(text=f"Calm â€¢ {today_ar}")

                await webhook.send(
                    embed=embed,
                    username="LYX Tweets",
                    avatar_url=AVATAR_URL,
                    allowed_mentions=discord.AllowedMentions.none()
                )

            await message.delete()

            async for msg in message.channel.history(limit=5):
                if msg.author.bot and msg.embeds and msg.embeds[0].description == message.content:
                    await msg.add_reaction("ğŸ”")
                    await msg.add_reaction("âœ…")
                    break

        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØºØ±ÙŠØ¯Ø©: {e}")
        return

    if message.content == ".":
        responses = ["Ù‡Ù„Ø§ Ù‚Ù„Ø¨ÙŠ", "ÙŠØ§ Ù…Ø±Ø­Ø¨Ø§Ø§", "Ù†ÙˆØ±Øª ÙŠØ§Ø¨Ø¹Ø¯Ù‡Ù…", "Ù‡Ù„Ø§ ÙˆØ§Ù„Ù„Ù‡", "Ø­ÙŠØ§Ù„Ù„Ù‡ Ù…Ù† Ø¬Ø§Ù†Ø§"]
        await message.channel.send(random.choice(responses))
    elif message.content.lower() == "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…":
        await message.channel.send("ÙˆØ¹Ù„ÙŠÙƒÙ… Ø§Ù„Ø³Ù„Ø§Ù… â¤ï¸")
    elif message.content.lower() == "Ù‡Ø§ÙŠ":
        await message.channel.send("Ù‡Ù„Ø§ ÙˆØºÙ„Ø§ ÙŠØ¨Ø¹Ø¯Ù‡Ù… ğŸŒ¸")

client.run(TOKEN)
